/*! norgeskartsok 27-01-2014 */
var nks=window.nks||{};!function(a){"use strict";var b=window.leafletUtils||{};b.SkTiles=function(a){return L.tileLayer("http://opencache.statkart.no/gatekeeper/gk/gk.open_gmaps?layers="+a.layers+"&zoom={z}&x={x}&y={y}")},a.MapView=Backbone.View.extend({initialize:function(){this.collection.on("reset",this.showMarkers,this),this.collection.on("selected",this.showMarker,this)},render:function(){return this.map=L.map(this.$el[0]).setView([65.5,15],5),b.SkTiles({layers:"topo2"}).addTo(this.map),this},showMarkers:function(a,b){this.map.setView([65.5,15],5),_.each(b.previousModels,function(a){a.has("marker")&&this.map.removeLayer(a.get("marker"))},this),this.collection.each(function(a){a.has("marker")&&this.map.addLayer(a.get("marker"))},this)},showMarker:function(a){this.collection.each(function(a){a.has("marker")&&this.map.removeLayer(a.get("marker"))},this);var b=a.get("marker");b.addTo(this.map),this.map.panTo(a.get("marker").getLatLng()).setZoom(12)}})}(nks);var nks=window.nks||{};!function(a){"use strict";var b=Backbone.Model.extend({initialize:function(a){_.bindAll(this,"selected");var b=a.LONGITUDE&&a.LATITUDE;if(b){var c=parseFloat(a.LONGITUDE.replace(",",".")),d=parseFloat(a.LATITUDE.replace(",",".")),e="EPSG:25832";a.EPSGKODE&&(e="EPSG:"+a.EPSGKODE);var f=proj4(e,"EPSG:4326",[c,d]);this.set("marker",L.marker([f[1],f[0]],{title:a.NAVN})),this.get("marker").on("click",this.selected)}},selected:function(){this.collection.trigger("selected",this)}});a.SearchCollection=Backbone.Collection.extend({url:"http://eiendom.statkart.no/Search.ashx",source:["sted","matreiendom","matrbygning","matradresse"],model:b,getSource:function(){return this.source.length?this.source.join(","):""},search:function(a){this.fetch({data:{filter:"KILDE:"+this.getSource(),term:a},dataType:"jsonp",reset:!0})}})}(nks);var nks=window.nks||{};!function(a){"use strict";var b=Backbone.View.extend({className:"input-group",events:{"keyup input":"search"},template:$("#search_form_template").html(),initialize:function(){_.bindAll(this,"search"),this.collection.on("selected",this.showResult,this)},render:function(){return this.$el.html(this.template),this},showResult:function(a){this.$("input").val(a.get("NAVN"))},search:function(){var a=this.$("input").val();""===a?this.collection.reset([]):this.collection.search(a)}}),c=Backbone.View.extend({tagName:"a",className:"list-group-item",events:{click:"selected"},template:"<%= NAVN %> (<%= KILDE %>)",initialize:function(){_.bindAll(this,"selected")},render:function(){return this.$el.attr("href","#"),this.$el.html(_.template(this.template,this.model.toJSON())),this},selected:function(a){a.preventDefault(),this.model.selected()}}),d=Backbone.View.extend({className:"list-group",initialize:function(){this.collection.on("reset",this.render,this),this.collection.on("selected",this.emptyResults,this)},render:function(){var a=this.collection.filter(function(a){return a.has("marker")});return a.length?(this.$el.html(_.map(a,function(a){return new c({model:a}).render().$el})),this.$el.removeClass("hidden")):this.emptyResults(),this},emptyResults:function(){this.$el.html(),this.$el.addClass("hidden")}});a.SearchView=Backbone.View.extend({className:"search-control",initialize:function(){this.searchField=new b({collection:this.collection}),this.resultsView=new d({collection:this.collection})},render:function(){return this.$el.append(this.searchField.render().$el),this.$el.append(this.resultsView.render().$el),this}})}(nks),function(){"use strict";proj4.defs("EPSG:25833","+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs"),proj4.defs("EPSG:25832","+proj=utm +zone=32 +ellps=GRS80 +units=m +no_defs");var a=new nks.SearchCollection,b=new nks.MapView({el:$("#map"),collection:a}).render();b.$el.append(new nks.SearchView({collection:a}).render().$el)}();